{"title":"tour","steps":[{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":280,"codeSnippet":"    /** Draws a blue circle badge with the step number. */\n    static final class NumberIcon implements Icon {\n        private final int number;\n        private final int size \u003d 16;\n        NumberIcon(int number) { this.number \u003d number; }\n        @Override public void paintIcon(Component c, Graphics g, int x, int y) {\n            Graphics2D g2 \u003d (Graphics2D) g.create();\n            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);\n            g2.setColor(new JBColor(new Color(0, 120, 215), new Color(0, 120, 215))); // Windows blue\n            g2.fillOval(x, y, size, size);\n            g2.setColor(JBColor.WHITE);\n            String s \u003d String.valueOf(number);\n            FontMetrics fm \u003d g2.getFontMetrics();\n            int tx \u003d x + (size - fm.stringWidth(s)) / 2;\n            int ty \u003d y + (size + fm.getAscent() - fm.getDescent()) / 2 - 1;\n            g2.drawString(s, tx, ty);\n            g2.dispose();\n        }\n        @Override public int getIconWidth() { return size; }\n        @Override public int getIconHeight() { return size; }\n    }","authorNote":"/** Draws a blue circle badge with the step number. */","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e/** Draws a blue circle badge with the step number. */\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    /** Draws a blue circle badge with the step number. */\n    static final class NumberIcon implements Icon {\n        private final int number;\n        private final int size \u003d 16;\n        NumberIcon(int number) { this.number \u003d number; }\n        @Override public void paintIcon(Component c, Graphics g, int x, int y) {\n            Graphics2D g2 \u003d (Graphics2D) g.create();\n            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);\n            g2.setColor(new JBColor(new Color(0, 120, 215), new Color(0, 120, 215))); // Windows blue\n            g2.fillOval(x, y, size, size);\n            g2.setColor(JBColor.WHITE);\n            String s \u003d String.valueOf(number);\n            FontMetrics fm \u003d g2.getFontMetrics();\n            int tx \u003d x + (size - fm.stringWidth(s)) / 2;\n            int ty \u003d y + (size + fm.getAscent() - fm.getDescent()) / 2 - 1;\n            g2.drawString(s, tx, ty);\n            g2.dispose();\n        }\n        @Override public int getIconWidth() { return size; }\n        @Override public int getIconHeight() { return size; }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":300,"symbolName":"com.hackathon.service.SelectionModeService.NumberIcon"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":257,"codeSnippet":"    /** Simple numbered icon for gutter. */\n    static final class NumberGutterIconRenderer extends GutterIconRenderer {\n        private final int index;\n        private final Icon icon;\n\n        NumberGutterIconRenderer(int index) {\n            this.index \u003d index;\n            this.icon \u003d new NumberIcon(index);\n        }\n\n        @Override\n        public @NotNull Icon getIcon() { return icon; }\n\n        @Override\n        public String getTooltipText() { return \"Tour Step #\" + index; }\n\n        @Override\n        public boolean equals(Object obj) { return obj instanceof NumberGutterIconRenderer r \u0026\u0026 r.index \u003d\u003d index; }\n\n        @Override\n        public int hashCode() { return Integer.hashCode(index); }\n    }","authorNote":"/** Simple numbered icon for gutter. */","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e/** Simple numbered icon for gutter. */\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    /** Simple numbered icon for gutter. */\n    static final class NumberGutterIconRenderer extends GutterIconRenderer {\n        private final int index;\n        private final Icon icon;\n\n        NumberGutterIconRenderer(int index) {\n            this.index \u003d index;\n            this.icon \u003d new NumberIcon(index);\n        }\n\n        @Override\n        public @NotNull Icon getIcon() { return icon; }\n\n        @Override\n        public String getTooltipText() { return \"Tour Step #\" + index; }\n\n        @Override\n        public boolean equals(Object obj) { return obj instanceof NumberGutterIconRenderer r \u0026amp;\u0026amp; r.index \u003d\u003d index; }\n\n        @Override\n        public int hashCode() { return Integer.hashCode(index); }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":278,"symbolName":"com.hackathon.service.SelectionModeService.NumberGutterIconRenderer"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":249,"codeSnippet":"    @Override\n    public void dispose() {\n        clearAllHighlighters();\n        for (Editor ed : new ArrayList\u003c\u003e(finishHuds.keySet())) {\n            detachFinishHud(ed);\n        }\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    @Override\n    public void dispose() {\n        clearAllHighlighters();\n        for (Editor ed : new ArrayList\u0026lt;\u0026gt;(finishHuds.keySet())) {\n            detachFinishHud(ed);\n        }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":255,"symbolName":"com.hackathon.service.SelectionModeService#dispose"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":316,"codeSnippet":"    private final class FinishHud extends JComponent {\n        private final Editor editor;\n        private final JButton finishBtn \u003d new JButton(\"Finish Tour\");\n        private final java.awt.event.ComponentListener compListener \u003d new java.awt.event.ComponentAdapter() {\n            @Override public void componentResized(java.awt.event.ComponentEvent e) { relayout(); }\n            @Override public void componentMoved(java.awt.event.ComponentEvent e) { relayout(); }\n        };\n        private final com.intellij.openapi.editor.event.VisibleAreaListener visibleAreaListener \u003d e -\u003e relayout();\n\n        FinishHud(Editor editor) {\n            this.editor \u003d editor;\n            setLayout(null);\n            setOpaque(false);\n            finishBtn.setBackground(new Color(0,120,215));\n            finishBtn.setForeground(Color.WHITE);\n            finishBtn.addActionListener(e -\u003e performFinalize());\n            add(finishBtn);\n        }\n\n        void attach() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            if (getParent() !\u003d layered) layered.add(this, JLayeredPane.POPUP_LAYER);\n            relayout();\n            editor.getContentComponent().addComponentListener(compListener);\n            editor.getScrollingModel().addVisibleAreaListener(visibleAreaListener);\n        }\n\n        void detach() {\n            Container p \u003d getParent();\n            if (p !\u003d null) p.remove(this);\n            try { editor.getContentComponent().removeComponentListener(compListener); } catch (Throwable ignore) {}\n            try { editor.getScrollingModel().removeVisibleAreaListener(visibleAreaListener); } catch (Throwable ignore) {}\n        }\n\n        private void relayout() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            Rectangle r \u003d SwingUtilities.convertRectangle(editor.getContentComponent(), editor.getContentComponent().getBounds(), layered);\n            setBounds(r);\n            int btnW \u003d 140, btnH \u003d 30;\n            finishBtn.setBounds(r.width - btnW - 20, 20, btnW, btnH);\n            revalidate();\n            repaint();\n        }\n\n        private void performFinalize() {\n            // Invoke FinalizeTourAction programmatically in the context of the editor\n            AnAction action \u003d ActionManager.getInstance().getAction(\"com.hackathon.actions.FinalizeTourAction\");\n            if (action !\u003d null) {\n                DataContext ctx \u003d SimpleDataContext.builder()\n                        .add(CommonDataKeys.PROJECT, project)\n                        .add(CommonDataKeys.EDITOR, editor)\n                        .build();\n                AnActionEvent ev \u003d AnActionEvent.createFromAnAction(action, null, \"AutoCodeWalker.SelectionHud\", ctx);\n                action.actionPerformed(ev);\n            }\n        }\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    private final class FinishHud extends JComponent {\n        private final Editor editor;\n        private final JButton finishBtn \u003d new JButton(\"Finish Tour\");\n        private final java.awt.event.ComponentListener compListener \u003d new java.awt.event.ComponentAdapter() {\n            @Override public void componentResized(java.awt.event.ComponentEvent e) { relayout(); }\n            @Override public void componentMoved(java.awt.event.ComponentEvent e) { relayout(); }\n        };\n        private final com.intellij.openapi.editor.event.VisibleAreaListener visibleAreaListener \u003d e -\u0026gt; relayout();\n\n        FinishHud(Editor editor) {\n            this.editor \u003d editor;\n            setLayout(null);\n            setOpaque(false);\n            finishBtn.setBackground(new Color(0,120,215));\n            finishBtn.setForeground(Color.WHITE);\n            finishBtn.addActionListener(e -\u0026gt; performFinalize());\n            add(finishBtn);\n        }\n\n        void attach() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            if (getParent() !\u003d layered) layered.add(this, JLayeredPane.POPUP_LAYER);\n            relayout();\n            editor.getContentComponent().addComponentListener(compListener);\n            editor.getScrollingModel().addVisibleAreaListener(visibleAreaListener);\n        }\n\n        void detach() {\n            Container p \u003d getParent();\n            if (p !\u003d null) p.remove(this);\n            try { editor.getContentComponent().removeComponentListener(compListener); } catch (Throwable ignore) {}\n            try { editor.getScrollingModel().removeVisibleAreaListener(visibleAreaListener); } catch (Throwable ignore) {}\n        }\n\n        private void relayout() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            Rectangle r \u003d SwingUtilities.convertRectangle(editor.getContentComponent(), editor.getContentComponent().getBounds(), layered);\n            setBounds(r);\n            int btnW \u003d 140, btnH \u003d 30;\n            finishBtn.setBounds(r.width - btnW - 20, 20, btnW, btnH);\n            revalidate();\n            repaint();\n        }\n\n        private void performFinalize() {\n            // Invoke FinalizeTourAction programmatically in the context of the editor\n            AnAction action \u003d ActionManager.getInstance().getAction(\"com.hackathon.actions.FinalizeTourAction\");\n            if (action !\u003d null) {\n                DataContext ctx \u003d SimpleDataContext.builder()\n                        .add(CommonDataKeys.PROJECT, project)\n                        .add(CommonDataKeys.EDITOR, editor)\n                        .build();\n                AnActionEvent ev \u003d AnActionEvent.createFromAnAction(action, null, \"AutoCodeWalker.SelectionHud\", ctx);\n                action.actionPerformed(ev);\n            }\n        }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":376,"symbolName":"com.hackathon.service.SelectionModeService.FinishHud"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":311,"codeSnippet":"    private void detachFinishHud(Editor editor) {\n        FinishHud hud \u003d finishHuds.remove(editor);\n        if (hud !\u003d null) hud.detach();\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    private void detachFinishHud(Editor editor) {\n        FinishHud hud \u003d finishHuds.remove(editor);\n        if (hud !\u003d null) hud.detach();\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":314,"symbolName":"com.hackathon.service.SelectionModeService#detachFinishHud"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":188,"codeSnippet":"    public void refreshEditorHighlighters(@NotNull Editor editor) {\n        clearHighlighters(editor);\n        if (!enabled) return;\n        Project p \u003d editor.getProject();\n        if (p \u003d\u003d null) return;\n        PsiFile psi \u003d getPsiFile(editor);\n        if (psi \u003d\u003d null || psi.getVirtualFile() \u003d\u003d null) return;\n        String path \u003d psi.getVirtualFile().getPath();\n        TourStateService state \u003d project.getService(TourStateService.class);\n        Document document \u003d editor.getDocument();\n\n        List\u003cRangeHighlighter\u003e list \u003d new ArrayList\u003c\u003e();\n        int index \u003d 1;\n        for (TourStep s : state.getSteps()) {\n            if (!Objects.equals(s.filePath(), path)) { index++; continue; }\n            int startLine0 \u003d Math.max(0, Math.min(document.getLineCount() - 1, s.lineNum() - 1));\n            int endLine0 \u003d Math.max(startLine0, Math.min(document.getLineCount() - 1, s.endLine() !\u003d null ? s.endLine() - 1 : startLine0));\n            int startOffset \u003d document.getLineStartOffset(startLine0);\n            int endOffset \u003d document.getLineEndOffset(endLine0);\n\n            TextAttributes attrs \u003d new TextAttributes();\n            boolean isMethod \u003d s.symbolName() !\u003d null \u0026\u0026 s.symbolName().contains(\"#\");\n            // Softer, dimmer highlight colors; class\u003dblue, method\u003dgreen\n            Color lightBg \u003d isMethod ? new Color(210, 245, 210) : new Color(210, 230, 255);\n            Color darkBg \u003d isMethod ? new Color(50, 70, 50) : new Color(50, 60, 80);\n            attrs.setBackgroundColor(new JBColor(lightBg, darkBg));\n            attrs.setEffectColor(isMethod ? new JBColor(new Color(0, 128, 0), new Color(120, 180, 120)) : JBColor.BLUE);\n            attrs.setEffectType(EffectType.BOXED);\n            attrs.setFontType(Font.BOLD);\n\n            MarkupModel markup \u003d editor.getMarkupModel();\n            RangeHighlighter rh \u003d markup.addRangeHighlighter(startOffset, endOffset, HighlighterLayer.SELECTION - 2, attrs, HighlighterTargetArea.EXACT_RANGE);\n            rh.setGutterIconRenderer(new NumberGutterIconRenderer(index));\n            list.add(rh);\n            index++;\n        }\n        editorHighlighters.put(editor, list);\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    public void refreshEditorHighlighters(@NotNull Editor editor) {\n        clearHighlighters(editor);\n        if (!enabled) return;\n        Project p \u003d editor.getProject();\n        if (p \u003d\u003d null) return;\n        PsiFile psi \u003d getPsiFile(editor);\n        if (psi \u003d\u003d null || psi.getVirtualFile() \u003d\u003d null) return;\n        String path \u003d psi.getVirtualFile().getPath();\n        TourStateService state \u003d project.getService(TourStateService.class);\n        Document document \u003d editor.getDocument();\n\n        List\u0026lt;RangeHighlighter\u0026gt; list \u003d new ArrayList\u0026lt;\u0026gt;();\n        int index \u003d 1;\n        for (TourStep s : state.getSteps()) {\n            if (!Objects.equals(s.filePath(), path)) { index++; continue; }\n            int startLine0 \u003d Math.max(0, Math.min(document.getLineCount() - 1, s.lineNum() - 1));\n            int endLine0 \u003d Math.max(startLine0, Math.min(document.getLineCount() - 1, s.endLine() !\u003d null ? s.endLine() - 1 : startLine0));\n            int startOffset \u003d document.getLineStartOffset(startLine0);\n            int endOffset \u003d document.getLineEndOffset(endLine0);\n\n            TextAttributes attrs \u003d new TextAttributes();\n            boolean isMethod \u003d s.symbolName() !\u003d null \u0026amp;\u0026amp; s.symbolName().contains(\"#\");\n            // Softer, dimmer highlight colors; class\u003dblue, method\u003dgreen\n            Color lightBg \u003d isMethod ? new Color(210, 245, 210) : new Color(210, 230, 255);\n            Color darkBg \u003d isMethod ? new Color(50, 70, 50) : new Color(50, 60, 80);\n            attrs.setBackgroundColor(new JBColor(lightBg, darkBg));\n            attrs.setEffectColor(isMethod ? new JBColor(new Color(0, 128, 0), new Color(120, 180, 120)) : JBColor.BLUE);\n            attrs.setEffectType(EffectType.BOXED);\n            attrs.setFontType(Font.BOLD);\n\n            MarkupModel markup \u003d editor.getMarkupModel();\n            RangeHighlighter rh \u003d markup.addRangeHighlighter(startOffset, endOffset, HighlighterLayer.SELECTION - 2, attrs, HighlighterTargetArea.EXACT_RANGE);\n            rh.setGutterIconRenderer(new NumberGutterIconRenderer(index));\n            list.add(rh);\n            index++;\n        }\n        editorHighlighters.put(editor, list);\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":225,"symbolName":"com.hackathon.service.SelectionModeService#refreshEditorHighlighters"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":172,"codeSnippet":"    private static String extractAuthorNote(PsiElement el) {\n        // Prefer Javadoc, then preceding comments on previous siblings\n        if (el instanceof PsiDocCommentOwner owner) {\n            PsiDocComment doc \u003d owner.getDocComment();\n            if (doc !\u003d null) {\n                return doc.getText();\n            }\n        }\n        PsiElement prev \u003d el.getPrevSibling();\n        while (prev !\u003d null \u0026\u0026 (prev instanceof PsiWhiteSpace)) prev \u003d prev.getPrevSibling();\n        if (prev instanceof PsiComment c) {\n            return c.getText();\n        }\n        return \"\";\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    private static String extractAuthorNote(PsiElement el) {\n        // Prefer Javadoc, then preceding comments on previous siblings\n        if (el instanceof PsiDocCommentOwner owner) {\n            PsiDocComment doc \u003d owner.getDocComment();\n            if (doc !\u003d null) {\n                return doc.getText();\n            }\n        }\n        PsiElement prev \u003d el.getPrevSibling();\n        while (prev !\u003d null \u0026amp;\u0026amp; (prev instanceof PsiWhiteSpace)) prev \u003d prev.getPrevSibling();\n        if (prev instanceof PsiComment c) {\n            return c.getText();\n        }\n        return \"\";\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":186,"symbolName":"com.hackathon.service.SelectionModeService#extractAuthorNote"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":162,"codeSnippet":"    private static String computeSymbolName(PsiElement el) {\n        if (el instanceof PsiMethod m) {\n            String cls \u003d Optional.ofNullable(m.getContainingClass()).map(PsiClass::getQualifiedName).orElse(\"\u003clocal\u003e\");\n            return cls + \"#\" + m.getName();\n        } else if (el instanceof PsiClass c) {\n            return Optional.ofNullable(c.getQualifiedName()).orElse(c.getName());\n        }\n        return null;\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    private static String computeSymbolName(PsiElement el) {\n        if (el instanceof PsiMethod m) {\n            String cls \u003d Optional.ofNullable(m.getContainingClass()).map(PsiClass::getQualifiedName).orElse(\"\u0026lt;local\u0026gt;\");\n            return cls + \"#\" + m.getName();\n        } else if (el instanceof PsiClass c) {\n            return Optional.ofNullable(c.getQualifiedName()).orElse(c.getName());\n        }\n        return null;\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":170,"symbolName":"com.hackathon.service.SelectionModeService#computeSymbolName"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":81,"codeSnippet":"    public void setEnabled(boolean enable) {\n        if (this.enabled \u003d\u003d enable) return;\n        this.enabled \u003d enable;\n        if (!enable) {\n            clearAllHighlighters();\n            // remove HUDs\n            for (Editor ed : new ArrayList\u003c\u003e(finishHuds.keySet())) {\n                detachFinishHud(ed);\n            }\n        } else {\n            for (Editor editor : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n                refreshEditorHighlighters(editor);\n                attachFinishHud(editor);\n            }\n        }\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    public void setEnabled(boolean enable) {\n        if (this.enabled \u003d\u003d enable) return;\n        this.enabled \u003d enable;\n        if (!enable) {\n            clearAllHighlighters();\n            // remove HUDs\n            for (Editor ed : new ArrayList\u0026lt;\u0026gt;(finishHuds.keySet())) {\n                detachFinishHud(ed);\n            }\n        } else {\n            for (Editor editor : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n                refreshEditorHighlighters(editor);\n                attachFinishHud(editor);\n            }\n        }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":96,"symbolName":"com.hackathon.service.SelectionModeService#setEnabled"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":49,"codeSnippet":"    public SelectionModeService(Project project) {\n        this.project \u003d project;\n\n        // Attach a factory listener to register mouse listener for new editors\n        com.intellij.openapi.editor.EditorFactory.getInstance().addEditorFactoryListener(new EditorFactoryListener() {\n            @Override\n            public void editorCreated(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                editor.addEditorMouseListener(editorMouseListener);\n                if (enabled) {\n                    refreshEditorHighlighters(editor);\n                    attachFinishHud(editor);\n                }\n            }\n\n            @Override\n            public void editorReleased(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                clearHighlighters(editor);\n                editor.removeEditorMouseListener(editorMouseListener);\n                detachFinishHud(editor);\n            }\n        }, this);\n\n        // Also attach listeners to already open editors (users may enable plugin mid-session)\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            ed.addEditorMouseListener(editorMouseListener);\n        }\n    }","authorNote":"","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e    public SelectionModeService(Project project) {\n        this.project \u003d project;\n\n        // Attach a factory listener to register mouse listener for new editors\n        com.intellij.openapi.editor.EditorFactory.getInstance().addEditorFactoryListener(new EditorFactoryListener() {\n            @Override\n            public void editorCreated(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                editor.addEditorMouseListener(editorMouseListener);\n                if (enabled) {\n                    refreshEditorHighlighters(editor);\n                    attachFinishHud(editor);\n                }\n            }\n\n            @Override\n            public void editorReleased(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                clearHighlighters(editor);\n                editor.removeEditorMouseListener(editorMouseListener);\n                detachFinishHud(editor);\n            }\n        }, this);\n\n        // Also attach listeners to already open editors (users may enable plugin mid-session)\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            ed.addEditorMouseListener(editorMouseListener);\n        }\n    }\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":77,"symbolName":"com.hackathon.service.SelectionModeService#SelectionModeService"},{"filePath":"C:/Users/lazar/IdeaProjects/JB-plugin/src/main/java/com/hackathon/service/SelectionModeService.java","lineNum":34,"codeSnippet":"/**\n * Project-level service that manages the \"Create Tour\" selection mode:\n * - Toggle selection mode on/off\n * - Listen to editor mouse clicks; when enabled, toggle selection of the enclosing function/class\n * - Maintain gutter index highlighters for all selections in the currently open editors\n */\n@Service(Service.Level.PROJECT)\npublic final class SelectionModeService implements Disposable {\n    private final Project project;\n    private volatile boolean enabled;\n\n    // Store editor-specific highlighters to clear on disable or editor disposal\n    private final Map\u003cEditor, List\u003cRangeHighlighter\u003e\u003e editorHighlighters \u003d new ConcurrentHashMap\u003c\u003e();\n    private final Map\u003cEditor, FinishHud\u003e finishHuds \u003d new ConcurrentHashMap\u003c\u003e();\n\n    public SelectionModeService(Project project) {\n        this.project \u003d project;\n\n        // Attach a factory listener to register mouse listener for new editors\n        com.intellij.openapi.editor.EditorFactory.getInstance().addEditorFactoryListener(new EditorFactoryListener() {\n            @Override\n            public void editorCreated(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                editor.addEditorMouseListener(editorMouseListener);\n                if (enabled) {\n                    refreshEditorHighlighters(editor);\n                    attachFinishHud(editor);\n                }\n            }\n\n            @Override\n            public void editorReleased(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                clearHighlighters(editor);\n                editor.removeEditorMouseListener(editorMouseListener);\n                detachFinishHud(editor);\n            }\n        }, this);\n\n        // Also attach listeners to already open editors (users may enable plugin mid-session)\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            ed.addEditorMouseListener(editorMouseListener);\n        }\n    }\n\n    public boolean isEnabled() { return enabled; }\n\n    public void setEnabled(boolean enable) {\n        if (this.enabled \u003d\u003d enable) return;\n        this.enabled \u003d enable;\n        if (!enable) {\n            clearAllHighlighters();\n            // remove HUDs\n            for (Editor ed : new ArrayList\u003c\u003e(finishHuds.keySet())) {\n                detachFinishHud(ed);\n            }\n        } else {\n            for (Editor editor : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n                refreshEditorHighlighters(editor);\n                attachFinishHud(editor);\n            }\n        }\n    }\n\n    private final EditorMouseListener editorMouseListener \u003d new EditorMouseListener() {\n        @Override\n        public void mouseClicked(@NotNull EditorMouseEvent e) {\n            if (!enabled) return;\n            Editor editor \u003d e.getEditor();\n            PsiFile psiFile \u003d getPsiFile(editor);\n            if (psiFile \u003d\u003d null) return;\n\n            int offset \u003d editor.logicalPositionToOffset(editor.xyToLogicalPosition(e.getMouseEvent().getPoint()));\n            PsiElement target \u003d findEnclosingSymbol(psiFile, offset);\n            if (target \u003d\u003d null) return;\n\n            // Build TourStep\n            Document doc \u003d editor.getDocument();\n            TextRange range \u003d target.getTextRange();\n            int startLine0 \u003d doc.getLineNumber(range.getStartOffset());\n            int endLine0 \u003d doc.getLineNumber(range.getEndOffset());\n            String code \u003d doc.getText(new TextRange(doc.getLineStartOffset(startLine0), doc.getLineEndOffset(endLine0)));\n            VirtualFile vFile \u003d psiFile.getVirtualFile();\n            if (vFile \u003d\u003d null) return;\n\n            String note \u003d extractAuthorNote(target);\n            String symbolName \u003d computeSymbolName(target);\n\n            TourStateService state \u003d project.getService(TourStateService.class);\n\n            // Toggle selection: if already present for same file+start line, remove it; else add it\n            Optional\u003cTourStep\u003e existing \u003d state.getSteps().stream()\n                    .filter(s -\u003e Objects.equals(s.filePath(), vFile.getPath()) \u0026\u0026 s.lineNum() \u003d\u003d (startLine0 + 1) \u0026\u0026\n                            Objects.equals(s.endLine(), endLine0 + 1))\n                    .findFirst();\n            if (existing.isPresent()) {\n                removeStep(state, existing.get());\n            } else {\n                TourStep step \u003d new TourStep(vFile.getPath(), startLine0 + 1, code, note, null, endLine0 + 1, symbolName);\n                state.addStep(step);\n            }\n\n            refreshAllEditors();\n        }\n    };\n\n    private void removeStep(TourStateService state, TourStep step) {\n        // Internal mutation helper: not exposed on service, so rebuild list\n        List\u003cTourStep\u003e copy \u003d new ArrayList\u003c\u003e(state.getSteps());\n        copy.remove(step);\n        state.clear();\n        for (TourStep s : copy) state.addStep(s);\n    }\n\n    private static PsiFile getPsiFile(Editor editor) {\n        Project project \u003d editor.getProject();\n        if (project \u003d\u003d null) return null;\n        return PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());\n    }\n\n    private static PsiElement findEnclosingSymbol(PsiFile file, int offset) {\n        PsiElement el \u003d file.findElementAt(offset);\n        while (el !\u003d null \u0026\u0026 !(el instanceof PsiMethod) \u0026\u0026 !(el instanceof PsiClass)) {\n            el \u003d el.getParent();\n        }\n        return el;\n    }\n\n    private static String computeSymbolName(PsiElement el) {\n        if (el instanceof PsiMethod m) {\n            String cls \u003d Optional.ofNullable(m.getContainingClass()).map(PsiClass::getQualifiedName).orElse(\"\u003clocal\u003e\");\n            return cls + \"#\" + m.getName();\n        } else if (el instanceof PsiClass c) {\n            return Optional.ofNullable(c.getQualifiedName()).orElse(c.getName());\n        }\n        return null;\n    }\n\n    private static String extractAuthorNote(PsiElement el) {\n        // Prefer Javadoc, then preceding comments on previous siblings\n        if (el instanceof PsiDocCommentOwner owner) {\n            PsiDocComment doc \u003d owner.getDocComment();\n            if (doc !\u003d null) {\n                return doc.getText();\n            }\n        }\n        PsiElement prev \u003d el.getPrevSibling();\n        while (prev !\u003d null \u0026\u0026 (prev instanceof PsiWhiteSpace)) prev \u003d prev.getPrevSibling();\n        if (prev instanceof PsiComment c) {\n            return c.getText();\n        }\n        return \"\";\n    }\n\n    public void refreshEditorHighlighters(@NotNull Editor editor) {\n        clearHighlighters(editor);\n        if (!enabled) return;\n        Project p \u003d editor.getProject();\n        if (p \u003d\u003d null) return;\n        PsiFile psi \u003d getPsiFile(editor);\n        if (psi \u003d\u003d null || psi.getVirtualFile() \u003d\u003d null) return;\n        String path \u003d psi.getVirtualFile().getPath();\n        TourStateService state \u003d project.getService(TourStateService.class);\n        Document document \u003d editor.getDocument();\n\n        List\u003cRangeHighlighter\u003e list \u003d new ArrayList\u003c\u003e();\n        int index \u003d 1;\n        for (TourStep s : state.getSteps()) {\n            if (!Objects.equals(s.filePath(), path)) { index++; continue; }\n            int startLine0 \u003d Math.max(0, Math.min(document.getLineCount() - 1, s.lineNum() - 1));\n            int endLine0 \u003d Math.max(startLine0, Math.min(document.getLineCount() - 1, s.endLine() !\u003d null ? s.endLine() - 1 : startLine0));\n            int startOffset \u003d document.getLineStartOffset(startLine0);\n            int endOffset \u003d document.getLineEndOffset(endLine0);\n\n            TextAttributes attrs \u003d new TextAttributes();\n            boolean isMethod \u003d s.symbolName() !\u003d null \u0026\u0026 s.symbolName().contains(\"#\");\n            // Softer, dimmer highlight colors; class\u003dblue, method\u003dgreen\n            Color lightBg \u003d isMethod ? new Color(210, 245, 210) : new Color(210, 230, 255);\n            Color darkBg \u003d isMethod ? new Color(50, 70, 50) : new Color(50, 60, 80);\n            attrs.setBackgroundColor(new JBColor(lightBg, darkBg));\n            attrs.setEffectColor(isMethod ? new JBColor(new Color(0, 128, 0), new Color(120, 180, 120)) : JBColor.BLUE);\n            attrs.setEffectType(EffectType.BOXED);\n            attrs.setFontType(Font.BOLD);\n\n            MarkupModel markup \u003d editor.getMarkupModel();\n            RangeHighlighter rh \u003d markup.addRangeHighlighter(startOffset, endOffset, HighlighterLayer.SELECTION - 2, attrs, HighlighterTargetArea.EXACT_RANGE);\n            rh.setGutterIconRenderer(new NumberGutterIconRenderer(index));\n            list.add(rh);\n            index++;\n        }\n        editorHighlighters.put(editor, list);\n    }\n\n    /** Refresh selection highlighters and gutter numbers across all open editors. */\n    public void refreshAllEditors() {\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            refreshEditorHighlighters(ed);\n        }\n    }\n\n    private void clearAllHighlighters() {\n        for (Editor ed : new ArrayList\u003c\u003e(editorHighlighters.keySet())) {\n            clearHighlighters(ed);\n        }\n    }\n\n    private void clearHighlighters(Editor editor) {\n        List\u003cRangeHighlighter\u003e list \u003d editorHighlighters.remove(editor);\n        if (list !\u003d null) {\n            for (RangeHighlighter h : list) {\n                try { h.dispose(); } catch (Throwable ignore) {}\n            }\n        }\n    }\n\n    @Override\n    public void dispose() {\n        clearAllHighlighters();\n        for (Editor ed : new ArrayList\u003c\u003e(finishHuds.keySet())) {\n            detachFinishHud(ed);\n        }\n    }\n\n    /** Simple numbered icon for gutter. */\n    static final class NumberGutterIconRenderer extends GutterIconRenderer {\n        private final int index;\n        private final Icon icon;\n\n        NumberGutterIconRenderer(int index) {\n            this.index \u003d index;\n            this.icon \u003d new NumberIcon(index);\n        }\n\n        @Override\n        public @NotNull Icon getIcon() { return icon; }\n\n        @Override\n        public String getTooltipText() { return \"Tour Step #\" + index; }\n\n        @Override\n        public boolean equals(Object obj) { return obj instanceof NumberGutterIconRenderer r \u0026\u0026 r.index \u003d\u003d index; }\n\n        @Override\n        public int hashCode() { return Integer.hashCode(index); }\n    }\n\n    /** Draws a blue circle badge with the step number. */\n    static final class NumberIcon implements Icon {\n        private final int number;\n        private final int size \u003d 16;\n        NumberIcon(int number) { this.number \u003d number; }\n        @Override public void paintIcon(Component c, Graphics g, int x, int y) {\n            Graphics2D g2 \u003d (Graphics2D) g.create();\n            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);\n            g2.setColor(new JBColor(new Color(0, 120, 215), new Color(0, 120, 215))); // Windows blue\n            g2.fillOval(x, y, size, size);\n            g2.setColor(JBColor.WHITE);\n            String s \u003d String.valueOf(number);\n            FontMetrics fm \u003d g2.getFontMetrics();\n            int tx \u003d x + (size - fm.stringWidth(s)) / 2;\n            int ty \u003d y + (size + fm.getAscent() - fm.getDescent()) / 2 - 1;\n            g2.drawString(s, tx, ty);\n            g2.dispose();\n        }\n        @Override public int getIconWidth() { return size; }\n        @Override public int getIconHeight() { return size; }\n    }\n\n    // --- Finish HUD (blue \"Finish Tour\" button shown during selection mode) ---\n    private void attachFinishHud(Editor editor) {\n        if (editor \u003d\u003d null || editor.getProject() \u003d\u003d null) return;\n        if (finishHuds.containsKey(editor)) return;\n        FinishHud hud \u003d new FinishHud(editor);\n        finishHuds.put(editor, hud);\n        hud.attach();\n    }\n\n    private void detachFinishHud(Editor editor) {\n        FinishHud hud \u003d finishHuds.remove(editor);\n        if (hud !\u003d null) hud.detach();\n    }\n\n    private final class FinishHud extends JComponent {\n        private final Editor editor;\n        private final JButton finishBtn \u003d new JButton(\"Finish Tour\");\n        private final java.awt.event.ComponentListener compListener \u003d new java.awt.event.ComponentAdapter() {\n            @Override public void componentResized(java.awt.event.ComponentEvent e) { relayout(); }\n            @Override public void componentMoved(java.awt.event.ComponentEvent e) { relayout(); }\n        };\n        private final com.intellij.openapi.editor.event.VisibleAreaListener visibleAreaListener \u003d e -\u003e relayout();\n\n        FinishHud(Editor editor) {\n            this.editor \u003d editor;\n            setLayout(null);\n            setOpaque(false);\n            finishBtn.setBackground(new Color(0,120,215));\n            finishBtn.setForeground(Color.WHITE);\n            finishBtn.addActionListener(e -\u003e performFinalize());\n            add(finishBtn);\n        }\n\n        void attach() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            if (getParent() !\u003d layered) layered.add(this, JLayeredPane.POPUP_LAYER);\n            relayout();\n            editor.getContentComponent().addComponentListener(compListener);\n            editor.getScrollingModel().addVisibleAreaListener(visibleAreaListener);\n        }\n\n        void detach() {\n            Container p \u003d getParent();\n            if (p !\u003d null) p.remove(this);\n            try { editor.getContentComponent().removeComponentListener(compListener); } catch (Throwable ignore) {}\n            try { editor.getScrollingModel().removeVisibleAreaListener(visibleAreaListener); } catch (Throwable ignore) {}\n        }\n\n        private void relayout() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            Rectangle r \u003d SwingUtilities.convertRectangle(editor.getContentComponent(), editor.getContentComponent().getBounds(), layered);\n            setBounds(r);\n            int btnW \u003d 140, btnH \u003d 30;\n            finishBtn.setBounds(r.width - btnW - 20, 20, btnW, btnH);\n            revalidate();\n            repaint();\n        }\n\n        private void performFinalize() {\n            // Invoke FinalizeTourAction programmatically in the context of the editor\n            AnAction action \u003d ActionManager.getInstance().getAction(\"com.hackathon.actions.FinalizeTourAction\");\n            if (action !\u003d null) {\n                DataContext ctx \u003d SimpleDataContext.builder()\n                        .add(CommonDataKeys.PROJECT, project)\n                        .add(CommonDataKeys.EDITOR, editor)\n                        .build();\n                AnActionEvent ev \u003d AnActionEvent.createFromAnAction(action, null, \"AutoCodeWalker.SelectionHud\", ctx);\n                action.actionPerformed(ev);\n            }\n        }\n    }\n}","authorNote":"/**\n * Project-level service that manages the \"Create Tour\" selection mode:\n * - Toggle selection mode on/off\n * - Listen to editor mouse clicks; when enabled, toggle selection of the enclosing function/class\n * - Maintain gutter index highlighters for all selections in the currently open editors\n */","aiExplanation":"\u003ch3\u003eAuthor Note\u003c/h3\u003e\u003cp\u003e/**\n * Project-level service that manages the \"Create Tour\" selection mode:\n * - Toggle selection mode on/off\n * - Listen to editor mouse clicks; when enabled, toggle selection of the enclosing function/class\n * - Maintain gutter index highlighters for all selections in the currently open editors\n */\u003c/p\u003e\u003ch3\u003eCode\u003c/h3\u003e\u003cpre\u003e/**\n * Project-level service that manages the \"Create Tour\" selection mode:\n * - Toggle selection mode on/off\n * - Listen to editor mouse clicks; when enabled, toggle selection of the enclosing function/class\n * - Maintain gutter index highlighters for all selections in the currently open editors\n */\n@Service(Service.Level.PROJECT)\npublic final class SelectionModeService implements Disposable {\n    private final Project project;\n    private volatile boolean enabled;\n\n    // Store editor-specific highlighters to clear on disable or editor disposal\n    private final Map\u0026lt;Editor, List\u0026lt;RangeHighlighter\u0026gt;\u0026gt; editorHighlighters \u003d new ConcurrentHashMap\u0026lt;\u0026gt;();\n    private final Map\u0026lt;Editor, FinishHud\u0026gt; finishHuds \u003d new ConcurrentHashMap\u0026lt;\u0026gt;();\n\n    public SelectionModeService(Project project) {\n        this.project \u003d project;\n\n        // Attach a factory listener to register mouse listener for new editors\n        com.intellij.openapi.editor.EditorFactory.getInstance().addEditorFactoryListener(new EditorFactoryListener() {\n            @Override\n            public void editorCreated(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                editor.addEditorMouseListener(editorMouseListener);\n                if (enabled) {\n                    refreshEditorHighlighters(editor);\n                    attachFinishHud(editor);\n                }\n            }\n\n            @Override\n            public void editorReleased(@NotNull EditorFactoryEvent event) {\n                Editor editor \u003d event.getEditor();\n                clearHighlighters(editor);\n                editor.removeEditorMouseListener(editorMouseListener);\n                detachFinishHud(editor);\n            }\n        }, this);\n\n        // Also attach listeners to already open editors (users may enable plugin mid-session)\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            ed.addEditorMouseListener(editorMouseListener);\n        }\n    }\n\n    public boolean isEnabled() { return enabled; }\n\n    public void setEnabled(boolean enable) {\n        if (this.enabled \u003d\u003d enable) return;\n        this.enabled \u003d enable;\n        if (!enable) {\n            clearAllHighlighters();\n            // remove HUDs\n            for (Editor ed : new ArrayList\u0026lt;\u0026gt;(finishHuds.keySet())) {\n                detachFinishHud(ed);\n            }\n        } else {\n            for (Editor editor : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n                refreshEditorHighlighters(editor);\n                attachFinishHud(editor);\n            }\n        }\n    }\n\n    private final EditorMouseListener editorMouseListener \u003d new EditorMouseListener() {\n        @Override\n        public void mouseClicked(@NotNull EditorMouseEvent e) {\n            if (!enabled) return;\n            Editor editor \u003d e.getEditor();\n            PsiFile psiFile \u003d getPsiFile(editor);\n            if (psiFile \u003d\u003d null) return;\n\n            int offset \u003d editor.logicalPositionToOffset(editor.xyToLogicalPosition(e.getMouseEvent().getPoint()));\n            PsiElement target \u003d findEnclosingSymbol(psiFile, offset);\n            if (target \u003d\u003d null) return;\n\n            // Build TourStep\n            Document doc \u003d editor.getDocument();\n            TextRange range \u003d target.getTextRange();\n            int startLine0 \u003d doc.getLineNumber(range.getStartOffset());\n            int endLine0 \u003d doc.getLineNumber(range.getEndOffset());\n            String code \u003d doc.getText(new TextRange(doc.getLineStartOffset(startLine0), doc.getLineEndOffset(endLine0)));\n            VirtualFile vFile \u003d psiFile.getVirtualFile();\n            if (vFile \u003d\u003d null) return;\n\n            String note \u003d extractAuthorNote(target);\n            String symbolName \u003d computeSymbolName(target);\n\n            TourStateService state \u003d project.getService(TourStateService.class);\n\n            // Toggle selection: if already present for same file+start line, remove it; else add it\n            Optional\u0026lt;TourStep\u0026gt; existing \u003d state.getSteps().stream()\n                    .filter(s -\u0026gt; Objects.equals(s.filePath(), vFile.getPath()) \u0026amp;\u0026amp; s.lineNum() \u003d\u003d (startLine0 + 1) \u0026amp;\u0026amp;\n                            Objects.equals(s.endLine(), endLine0 + 1))\n                    .findFirst();\n            if (existing.isPresent()) {\n                removeStep(state, existing.get());\n            } else {\n                TourStep step \u003d new TourStep(vFile.getPath(), startLine0 + 1, code, note, null, endLine0 + 1, symbolName);\n                state.addStep(step);\n            }\n\n            refreshAllEditors();\n        }\n    };\n\n    private void removeStep(TourStateService state, TourStep step) {\n        // Internal mutation helper: not exposed on service, so rebuild list\n        List\u0026lt;TourStep\u0026gt; copy \u003d new ArrayList\u0026lt;\u0026gt;(state.getSteps());\n        copy.remove(step);\n        state.clear();\n        for (TourStep s : copy) state.addStep(s);\n    }\n\n    private static PsiFile getPsiFile(Editor editor) {\n        Project project \u003d editor.getProject();\n        if (project \u003d\u003d null) return null;\n        return PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());\n    }\n\n    private static PsiElement findEnclosingSymbol(PsiFile file, int offset) {\n        PsiElement el \u003d file.findElementAt(offset);\n        while (el !\u003d null \u0026amp;\u0026amp; !(el instanceof PsiMethod) \u0026amp;\u0026amp; !(el instanceof PsiClass)) {\n            el \u003d el.getParent();\n        }\n        return el;\n    }\n\n    private static String computeSymbolName(PsiElement el) {\n        if (el instanceof PsiMethod m) {\n            String cls \u003d Optional.ofNullable(m.getContainingClass()).map(PsiClass::getQualifiedName).orElse(\"\u0026lt;local\u0026gt;\");\n            return cls + \"#\" + m.getName();\n        } else if (el instanceof PsiClass c) {\n            return Optional.ofNullable(c.getQualifiedName()).orElse(c.getName());\n        }\n        return null;\n    }\n\n    private static String extractAuthorNote(PsiElement el) {\n        // Prefer Javadoc, then preceding comments on previous siblings\n        if (el instanceof PsiDocCommentOwner owner) {\n            PsiDocComment doc \u003d owner.getDocComment();\n            if (doc !\u003d null) {\n                return doc.getText();\n            }\n        }\n        PsiElement prev \u003d el.getPrevSibling();\n        while (prev !\u003d null \u0026amp;\u0026amp; (prev instanceof PsiWhiteSpace)) prev \u003d prev.getPrevSibling();\n        if (prev instanceof PsiComment c) {\n            return c.getText();\n        }\n        return \"\";\n    }\n\n    public void refreshEditorHighlighters(@NotNull Editor editor) {\n        clearHighlighters(editor);\n        if (!enabled) return;\n        Project p \u003d editor.getProject();\n        if (p \u003d\u003d null) return;\n        PsiFile psi \u003d getPsiFile(editor);\n        if (psi \u003d\u003d null || psi.getVirtualFile() \u003d\u003d null) return;\n        String path \u003d psi.getVirtualFile().getPath();\n        TourStateService state \u003d project.getService(TourStateService.class);\n        Document document \u003d editor.getDocument();\n\n        List\u0026lt;RangeHighlighter\u0026gt; list \u003d new ArrayList\u0026lt;\u0026gt;();\n        int index \u003d 1;\n        for (TourStep s : state.getSteps()) {\n            if (!Objects.equals(s.filePath(), path)) { index++; continue; }\n            int startLine0 \u003d Math.max(0, Math.min(document.getLineCount() - 1, s.lineNum() - 1));\n            int endLine0 \u003d Math.max(startLine0, Math.min(document.getLineCount() - 1, s.endLine() !\u003d null ? s.endLine() - 1 : startLine0));\n            int startOffset \u003d document.getLineStartOffset(startLine0);\n            int endOffset \u003d document.getLineEndOffset(endLine0);\n\n            TextAttributes attrs \u003d new TextAttributes();\n            boolean isMethod \u003d s.symbolName() !\u003d null \u0026amp;\u0026amp; s.symbolName().contains(\"#\");\n            // Softer, dimmer highlight colors; class\u003dblue, method\u003dgreen\n            Color lightBg \u003d isMethod ? new Color(210, 245, 210) : new Color(210, 230, 255);\n            Color darkBg \u003d isMethod ? new Color(50, 70, 50) : new Color(50, 60, 80);\n            attrs.setBackgroundColor(new JBColor(lightBg, darkBg));\n            attrs.setEffectColor(isMethod ? new JBColor(new Color(0, 128, 0), new Color(120, 180, 120)) : JBColor.BLUE);\n            attrs.setEffectType(EffectType.BOXED);\n            attrs.setFontType(Font.BOLD);\n\n            MarkupModel markup \u003d editor.getMarkupModel();\n            RangeHighlighter rh \u003d markup.addRangeHighlighter(startOffset, endOffset, HighlighterLayer.SELECTION - 2, attrs, HighlighterTargetArea.EXACT_RANGE);\n            rh.setGutterIconRenderer(new NumberGutterIconRenderer(index));\n            list.add(rh);\n            index++;\n        }\n        editorHighlighters.put(editor, list);\n    }\n\n    /** Refresh selection highlighters and gutter numbers across all open editors. */\n    public void refreshAllEditors() {\n        for (Editor ed : com.intellij.openapi.editor.EditorFactory.getInstance().getAllEditors()) {\n            refreshEditorHighlighters(ed);\n        }\n    }\n\n    private void clearAllHighlighters() {\n        for (Editor ed : new ArrayList\u0026lt;\u0026gt;(editorHighlighters.keySet())) {\n            clearHighlighters(ed);\n        }\n    }\n\n    private void clearHighlighters(Editor editor) {\n        List\u0026lt;RangeHighlighter\u0026gt; list \u003d editorHighlighters.remove(editor);\n        if (list !\u003d null) {\n            for (RangeHighlighter h : list) {\n                try { h.dispose(); } catch (Throwable ignore) {}\n            }\n        }\n    }\n\n    @Override\n    public void dispose() {\n        clearAllHighlighters();\n        for (Editor ed : new ArrayList\u0026lt;\u0026gt;(finishHuds.keySet())) {\n            detachFinishHud(ed);\n        }\n    }\n\n    /** Simple numbered icon for gutter. */\n    static final class NumberGutterIconRenderer extends GutterIconRenderer {\n        private final int index;\n        private final Icon icon;\n\n        NumberGutterIconRenderer(int index) {\n            this.index \u003d index;\n            this.icon \u003d new NumberIcon(index);\n        }\n\n        @Override\n        public @NotNull Icon getIcon() { return icon; }\n\n        @Override\n        public String getTooltipText() { return \"Tour Step #\" + index; }\n\n        @Override\n        public boolean equals(Object obj) { return obj instanceof NumberGutterIconRenderer r \u0026amp;\u0026amp; r.index \u003d\u003d index; }\n\n        @Override\n        public int hashCode() { return Integer.hashCode(index); }\n    }\n\n    /** Draws a blue circle badge with the step number. */\n    static final class NumberIcon implements Icon {\n        private final int number;\n        private final int size \u003d 16;\n        NumberIcon(int number) { this.number \u003d number; }\n        @Override public void paintIcon(Component c, Graphics g, int x, int y) {\n            Graphics2D g2 \u003d (Graphics2D) g.create();\n            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);\n            g2.setColor(new JBColor(new Color(0, 120, 215), new Color(0, 120, 215))); // Windows blue\n            g2.fillOval(x, y, size, size);\n            g2.setColor(JBColor.WHITE);\n            String s \u003d String.valueOf(number);\n            FontMetrics fm \u003d g2.getFontMetrics();\n            int tx \u003d x + (size - fm.stringWidth(s)) / 2;\n            int ty \u003d y + (size + fm.getAscent() - fm.getDescent()) / 2 - 1;\n            g2.drawString(s, tx, ty);\n            g2.dispose();\n        }\n        @Override public int getIconWidth() { return size; }\n        @Override public int getIconHeight() { return size; }\n    }\n\n    // --- Finish HUD (blue \"Finish Tour\" button shown during selection mode) ---\n    private void attachFinishHud(Editor editor) {\n        if (editor \u003d\u003d null || editor.getProject() \u003d\u003d null) return;\n        if (finishHuds.containsKey(editor)) return;\n        FinishHud hud \u003d new FinishHud(editor);\n        finishHuds.put(editor, hud);\n        hud.attach();\n    }\n\n    private void detachFinishHud(Editor editor) {\n        FinishHud hud \u003d finishHuds.remove(editor);\n        if (hud !\u003d null) hud.detach();\n    }\n\n    private final class FinishHud extends JComponent {\n        private final Editor editor;\n        private final JButton finishBtn \u003d new JButton(\"Finish Tour\");\n        private final java.awt.event.ComponentListener compListener \u003d new java.awt.event.ComponentAdapter() {\n            @Override public void componentResized(java.awt.event.ComponentEvent e) { relayout(); }\n            @Override public void componentMoved(java.awt.event.ComponentEvent e) { relayout(); }\n        };\n        private final com.intellij.openapi.editor.event.VisibleAreaListener visibleAreaListener \u003d e -\u0026gt; relayout();\n\n        FinishHud(Editor editor) {\n            this.editor \u003d editor;\n            setLayout(null);\n            setOpaque(false);\n            finishBtn.setBackground(new Color(0,120,215));\n            finishBtn.setForeground(Color.WHITE);\n            finishBtn.addActionListener(e -\u0026gt; performFinalize());\n            add(finishBtn);\n        }\n\n        void attach() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            if (getParent() !\u003d layered) layered.add(this, JLayeredPane.POPUP_LAYER);\n            relayout();\n            editor.getContentComponent().addComponentListener(compListener);\n            editor.getScrollingModel().addVisibleAreaListener(visibleAreaListener);\n        }\n\n        void detach() {\n            Container p \u003d getParent();\n            if (p !\u003d null) p.remove(this);\n            try { editor.getContentComponent().removeComponentListener(compListener); } catch (Throwable ignore) {}\n            try { editor.getScrollingModel().removeVisibleAreaListener(visibleAreaListener); } catch (Throwable ignore) {}\n        }\n\n        private void relayout() {\n            JRootPane root \u003d SwingUtilities.getRootPane(editor.getContentComponent());\n            if (root \u003d\u003d null) return;\n            JLayeredPane layered \u003d root.getLayeredPane();\n            Rectangle r \u003d SwingUtilities.convertRectangle(editor.getContentComponent(), editor.getContentComponent().getBounds(), layered);\n            setBounds(r);\n            int btnW \u003d 140, btnH \u003d 30;\n            finishBtn.setBounds(r.width - btnW - 20, 20, btnW, btnH);\n            revalidate();\n            repaint();\n        }\n\n        private void performFinalize() {\n            // Invoke FinalizeTourAction programmatically in the context of the editor\n            AnAction action \u003d ActionManager.getInstance().getAction(\"com.hackathon.actions.FinalizeTourAction\");\n            if (action !\u003d null) {\n                DataContext ctx \u003d SimpleDataContext.builder()\n                        .add(CommonDataKeys.PROJECT, project)\n                        .add(CommonDataKeys.EDITOR, editor)\n                        .build();\n                AnActionEvent ev \u003d AnActionEvent.createFromAnAction(action, null, \"AutoCodeWalker.SelectionHud\", ctx);\n                action.actionPerformed(ev);\n            }\n        }\n    }\n}\u003c/pre\u003e\u003cp\u003e\u003cem\u003e(Set OPENAI_API_KEY to enable AI explanations.)\u003c/em\u003e\u003c/p\u003e","endLine":377,"symbolName":"com.hackathon.service.SelectionModeService"}]}